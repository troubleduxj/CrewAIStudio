# 迁移错误处理和故障排除指南

本指南提供了关于 CrewAI Studio 迁移系统中错误处理的全面信息以及常见问题的故障排除步骤。

## 错误类型和处理

### 1. 数据库连接错误

**错误类型**：`DatabaseConnectionError`

**常见原因**：
- 数据库服务器未运行
- 连接参数不正确
- 网络连接问题
- 权限问题

**故障排除步骤**：
1. 检查数据库服务器是否正在运行且可访问
2. 验证 DATABASE_URL 中的数据库连接参数
3. 确保数据库存在且您有适当的权限
4. 对于 SQLite：检查数据库文件是否存在且可读
5. 对于 PostgreSQL：验证网络连接和凭据
6. 使用数据库客户端工具手动测试连接

**示例错误消息**：
```
DatabaseConnectionError: 由于连接错误无法确定当前数据库版本
原始错误: (sqlite3.OperationalError) 文件不存在: ./nonexistent.db
```

### 2. 迁移冲突错误

**错误类型**：`MigrationConflictError`

**常见原因**：
- 多个开发者同时创建迁移
- 在迁移之外手动更改数据库
- 迁移历史损坏

**故障排除步骤**：
1. 检查迁移历史中的冲突：`python migration_cli.py history`
2. 与团队成员协调迁移顺序
3. 通过合并或重新排序迁移来解决冲突
4. 考虑创建新迁移来修复冲突
5. 对于复杂的冲突解决使用 `alembic merge`

### 3. 架构验证错误

**错误类型**：`SchemaValidationError`

**常见原因**：
- 模型定义与数据库架构不匹配
- 缺失或多余的列/表
- 约束违反

**故障排除步骤**：
1. 比较模型定义与实际数据库架构
2. 检查缺失的迁移
3. 验证所有模型更改都有相应的迁移
4. 使用 `alembic revision --autogenerate` 检测差异
5. 审查并修复任何数据完整性问题

### 4. 一般迁移错误

**错误类型**：`MigrationError`

**常见原因**：
- 迁移文件中的语法错误
- 缺失依赖
- 配置问题

**故障排除步骤**：
1. 检查迁移文件语法错误
2. 验证所有必需的依赖项已安装
3. 审查 Alembic 配置 (alembic.ini)
4. 检查 Python 路径和导入语句
5. 验证模型导入和定义

## 日志记录和监控

### 日志级别

迁移系统使用结构化日志记录，具有以下级别：

- **DEBUG**：详细的诊断信息
- **INFO**：一般操作消息
- **WARNING**：不阻止操作的潜在问题
- **ERROR**：阻止成功操作的错误

### 日志格式

日志包含以下信息：
- 时间戳
- 日志级别
- 模块名称
- 消息
- 上下文信息（数据库类型、版本 ID 等）

### 示例日志输出

```
2025-01-10 10:30:15.123 | INFO     | migration:get_current_revision:45 - 连接到数据库获取当前版本: sqlite://[已隐藏]
2025-01-10 10:30:15.125 | DEBUG    | migration:get_current_revision:50 - 已建立数据库连接进行版本检查
2025-01-10 10:30:15.127 | INFO     | migration:get_current_revision:55 - 当前数据库版本: abc123def456
```

## 常见错误场景

### 场景 1：全新数据库设置

**情况**：在全新数据库上运行迁移

**预期行为**：
- 当前版本将为 `None`
- 所有迁移都将待处理
- 第一个迁移应创建完整架构

**故障排除**：
```bash
# 检查状态
python migration_cli.py status

# 应用所有迁移
python migration_cli.py upgrade --backup
```

### 场景 2：数据库不同步

**情况**：数据库架构与迁移历史不匹配

**症状**：
- 自动生成为现有表创建迁移
- 由于现有对象导致迁移失败

**故障排除**：
```bash
# 检查当前状态
python migration_cli.py status

# 生成迁移以同步
python migration_cli.py generate "sync_database_schema"

# 审查并编辑生成的迁移
# 应用迁移
python migration_cli.py upgrade
```

### 场景 3：需要迁移回滚

**情况**：需要撤销有问题的迁移

**步骤**：
```bash
# 首先创建备份
python migration_cli.py backup --verify

# 检查迁移历史
python migration_cli.py history

# 降级到之前的版本
python migration_cli.py downgrade <previous_revision>
```

### 场景 4：多种数据库类型

**情况**：支持 SQLite（开发）和 PostgreSQL（生产）

**考虑因素**：
- SQLite 对 ALTER TABLE 的支持有限
- SQLite 自动启用批处理模式
- 在两种数据库类型上测试迁移

**最佳实践**：
1. 使用批处理模式以兼容 SQLite
2. 在两种数据库类型上测试迁移
3. 了解数据库特定功能
4. 使用适当的数据类型以实现跨兼容性

## 错误恢复程序

### 1. 备份和恢复

在重大操作前始终创建备份：

```bash
# 创建备份
python migration_cli.py backup --verify

# 如果迁移失败，从备份恢复
# 对于 SQLite：
cp backup_file.db current_database.db

# 对于 PostgreSQL：
psql -d database_name -f backup_file.sql
```

### 2. 手动架构修复

如果迁移因架构问题失败：

1. 记录当前数据库状态
2. 识别具体问题（缺失表、列等）
3. 创建手动迁移来修复问题
4. 在数据库副本上测试修复
5. 将修复应用到生产环境

### 3. 迁移历史修复

如果迁移历史损坏：

1. 备份当前数据库
2. 导出当前架构结构
3. 创建全新的迁移历史
4. 从当前架构生成初始迁移
5. 测试新的迁移系统

## 预防最佳实践

### 1. 开发工作流

- 始终为模型更改创建迁移
- 首先在开发数据库上测试迁移
- 在应用前审查生成的迁移
- 与团队协调迁移顺序
- 使用描述性的迁移消息

### 2. 部署工作流

- 部署前创建数据库备份
- 在启动应用程序前应用迁移
- 部署期间监控迁移日志
- 准备好回滚程序
- 在暂存环境中测试迁移

### 3. 监控和警报

- 监控迁移执行时间
- 迁移失败时发出警报
- 记录所有迁移操作
- 跟踪数据库架构更改
- 迁移后监控数据库性能

## 获取帮助

### 1. 检查日志

审查详细日志以获取特定错误信息：
- 应用程序日志包含迁移操作详细信息
- 数据库服务器日志可能包含额外的错误信息
- 系统日志可能显示权限或连接问题

### 2. 验证配置

验证所有配置是否正确：
- 数据库连接参数
- Alembic 配置 (alembic.ini)
- 模型导入和定义
- 环境变量

### 3. 隔离测试

创建最小测试用例：
- 使用单独的测试数据库
- 逐步应用迁移
- 隔离有问题的操作
- 使用最小数据集测试

### 4. 社区资源

- 查看 Alembic 文档：https://alembic.sqlalchemy.org/
- SQLAlchemy 文档：https://docs.sqlalchemy.org/
- 在项目文档中搜索类似问题
- 审查迁移工具源代码以了解实现详细信息

## 错误消息参考

### 连接错误

```
DatabaseConnectionError: 由于连接错误无法确定当前数据库版本
```
**解决方案**：检查数据库连接和凭据

### 导入错误

```
MigrationError: 由于导入错误，迁移生成失败
```
**解决方案**：修复模型导入问题和依赖项

### 版本错误

```
MigrationError: 在迁移历史中找不到迁移版本 'abc123'
```
**解决方案**：检查版本 ID 和迁移文件存在性

### 约束错误

```
MigrationError: 由于约束违反，数据库升级失败
```
**解决方案**：在应用迁移前修复数据完整性问题

本指南应该帮助您诊断和解决大多数与迁移相关的问题。对于复杂问题，考虑创建最小重现案例并查阅增强错误处理系统提供的详细错误消息和故障排除步骤。